# SftpDeployer

一个基于 WPF 的多服务器 SFTP 部署小工具。通过简单直观的界面，把本地文件一键上传到多个服务器；支持为每个文件设置目标路径、权限（chmod），并在上传前/后通过 SSH 在远程服务器执行自定义脚本（YAML）。

适用场景：
- 多台测试/生产服务器需要同时分发前端构建物、配置文件、脚本或二进制包。
- 希望跳过未变化的文件，提升上传效率。
- 需要在上传前/后执行一些命令（如备份、解压、重启服务、刷新缓存等）。

---

## 功能特性
- 多服务器配置与快速选择
  - 支持添加多个服务器（IP/端口/用户名/密码）。
  - 服务器按“别名”排序，编辑别名结束（焦点离开）后再触发重新排序。
  - 仅支持密码认证（当前版本不含密钥登录）。
- 文件管理与一键上传
  - 添加多个本地文件，为每个文件设置目标远程路径（如 /opt/app/app.tar.gz）。
  - 为每个文件勾选要部署到的服务器集合。
  - “主页”提供精简的勾选面板和“一键上传”按钮，可拖拽行进行排序（上传顺序即为该顺序）。
  - 拖拽分隔条调整日志区域高度，比例会自动保存。
- 差异化上传与安全替换
  - 计算本地与远端文件 SHA-256，若相同则跳过重传（仍会根据需要设置权限并执行 after_script）。
  - 采用“临时文件上传 + 原子重命名”的策略，尽可能避免半上传状态。
- 权限设置（可选）
  - 在“权限”列输入 0-7 三位数字（如 755/644），留空则不设置权限。
  - 上传完成后为目标文件执行 chmod；若文件未变更也会尝试应用权限。
- 上传前/后脚本（YAML）
  - 在远程服务器上通过 SSH 顺序执行 before_script / after_script 中的命令。
  - 支持在命令中使用变量（如 \${FILE_NAME}、\${SERVER_ALIAS} 等）。
- 实时日志与进度
  - 以彩色区分“命令”和“输出”，展示每个步骤的结果。
  - 展示总体进度百分比与状态汇总。
- 自动保存配置
  - 自动持久化服务器列表、文件列表、勾选状态、脚本内容、窗口尺寸与日志区域比例等。
  - 配置文件路径：%APPDATA%\SftpDeployer\config.json。

---

## 界面与工作流
应用分为 3 个页签：

1) 主页
- 上方：文件清单（只读展示），“服务器”列显示该文件在“文件配置”中已勾选的服务器的精简勾选框，可快速临时选择本次要上传的目标。
- 中间：可拖拽的分隔条。
- 下方：上传按钮、总体进度条与日志区域。
- 支持在该表内拖动行实现排序；该顺序即为上传顺序。

2) 文件配置
- 通过“添加文件”选择本地文件；默认目标路径为“/文件名”，可自行修改。
- 在“服务器”列为该文件勾选允许部署的服务器集合（作为该文件的“长期允许列表”）。
- “权限”列可填写 0-7 三位（如 755）；留空表示不设置权限。
- “脚本”列点击“编辑”，以 YAML 格式设置 before_script / after_script。

3) 服务器配置
- 管理服务器：别名、服务器IP、端口（默认 22）、用户名、密码。
- 支持多选删除。
- 按别名排序；只有当别名编辑结束（焦点离开）时才触发重新排序。

---

## 使用步骤
1. 配置服务器
   - 切换到“服务器配置”页，点击“添加服务器”，填写别名/Host/Port/Username/Password。
   - 可添加多台服务器；别名用于在界面中识别与排序。

2. 添加文件
   - 切换到“文件配置”页，点击“添加文件”，可多选。
   - 修改“目标路径”，例如：/opt/site/index.html 或 /opt/app/release/app.zip。
   - 在“服务器”列勾选该文件允许部署到的服务器集合。
   - 如果需要，设置“权限”（如 755）。
   - 如需在上传的前后执行命令，点击“脚本”→“编辑”并填写 YAML。

3. 快速选择并上传
   - 切回“主页”，按需勾选本次要上传的服务器（这里只显示文件在“文件配置”中勾选过的服务器）。
   - 可拖拽调整文件顺序。
   - 点击“一键上传”。

4. 查看日志
   - 日志会展示每个服务器的 before_script / 上传 / after_script 的信息以及命令与结果；失败会有中文错误提示（如认证失败、连接超时等）。

---

## 脚本说明（YAML）
- 脚本键：
  - before_script: 数组，上传前依次执行。
  - after_script:  数组，上传后依次执行（即使文件未变化也会执行）。
- 脚本在“远程服务器”上通过 SSH 执行；执行失败（非 0 退出码）会中断该阶段后续命令与上传流程。
- 命令中可使用如下变量（形如 ${VAR}）：
  - ${FILE_LOCAL_PATH}  本地文件完整路径
  - ${FILE_TARGET_PATH} 配置中的目标路径
  - ${FILE_REMOTE_PATH} 实际上传到服务器的完整路径
  - ${FILE_NAME}        文件名
  - ${PERMISSION}       上传后要设置的权限（例如 755）
  - ${SERVER_ALIAS}     服务器别名
  - ${SERVER_HOST}      服务器地址
  - ${SERVER_PORT}      端口
  - ${SERVER_USERNAME}  用户名

示例：
```yaml
before_script:
  - echo "[PRE] 将部署 ${FILE_NAME} 到 ${SERVER_ALIAS}:${SERVER_HOST}:${SERVER_PORT}"
  - mkdir -p /opt/backup && cp -f ${FILE_TARGET_PATH} /opt/backup/${FILE_NAME}.bak || true

after_script:
  - echo "[POST] 已上传至 ${FILE_REMOTE_PATH}，准备重启服务"
  - systemctl restart my-service
```

注意：命令在 SSH 远端执行，确保相应命令在目标服务器上可用，且当前用户具备权限。

---

## 权限设置说明
- 在“权限”输入框内仅允许 0-7 数字，最多 3 位（例如 755、644）。
- 留空表示不设置权限。
- 应用方式：上传完成后通过 SFTP 的 ChangePermissions 调用对目标文件执行 chmod；若发现远端文件和本地文件哈希一致而跳过上传，也会尝试设置权限。

---

## 配置存储
- 应用会在以下路径自动保存配置：
  - `%APPDATA%\\SftpDeployer\\config.json`
- 保存内容包含：
  - 服务器列表（含明文密码）、文件列表、每个文件的允许服务器集合、主页的临时选择、脚本内容、权限、窗口尺寸、窗口状态、主页日志区域比例。
- 安全提示：密码为明文存储，仅供离线桌面工具使用场景，建议确保此文件夹的访问权限并避免提交到版本库。

---

## 构建与运行
前置条件：
- Windows 10/11
- .NET SDK 9.0（含 Windows 桌面开发组件）
- Visual Studio 2022（17.10+）或 JetBrains Rider（推荐）

步骤：
1. 克隆仓库并在 IDE 中打开解决方案 `SftpDeployer.sln`。
2. 还原 NuGet 包（WPF-UI、SSH.NET、YamlDotNet）。
3. 以 Release/Debug 构建并运行（目标框架：`net9.0-windows`）。
4. 生成的可执行文件位于 `bin/Release/net9.0-windows/` 或 `bin/Debug/net9.0-windows/`。

也可使用命令行运行（PowerShell）：
```powershell
# 进入项目目录
# dotnet restore
# dotnet build -c Release
# dotnet run -c Release
```

---

## 常见问题（FAQ）
- 认证失败/连接失败？
  - 检查用户名/密码/端口/服务器连通性；日志会显示“认证失败”“连接超时”等中文提示。
- 上传后权限未生效？
  - 确认“权限”输入为 0-7 的三位数字；确认当前 SSH 用户有修改权限的能力；查看日志中的“设置权限失败”具体原因。
- 文件未更新却仍显示成功？
  - 当检测到远端文件与本地文件哈希一致时，会跳过上传，但仍可能会设置权限并执行 after_script；日志会提示“已是最新，无需更新”。
- 可否使用密钥登录或跳板机？
  - 当前版本仅支持密码认证，不支持私钥/代理跳转。
- 是否支持目录上传？
  - 当前仅支持文件列表，不支持整目录打包/上传（可通过脚本实现压缩与解压流程）。

---

## 目录结构（简要）
- `MainWindow.xaml / .cs`：主界面与核心逻辑（文件/服务器配置、上传流程、日志）。
- `ScriptEditorWindow.xaml / .cs`：脚本编辑弹窗，提供 YAML 模板与变量说明。
- `App.xaml`：WPF 启动配置。
- `SftpDeployer.csproj`：项目与依赖（WPF-UI / SSH.NET / YamlDotNet）。

---

## 免责声明
本工具不会将任何配置或凭据上传到网络，但会在本机 `%APPDATA%` 目录以明文保存密码；请妥善保护计算机与用户目录访问权限。生产环境使用前请评估风险并在测试环境验证流程。
