<ui:FluentWindow x:Class="SftpDeployer.MainWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
                 xmlns:sys="clr-namespace:System;assembly=System.Runtime"
                 Title="SFTP 部署器"
                 Height="600" Width="980"
                 ExtendsContentIntoTitleBar="True">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <ui:TitleBar />
        <TabControl Grid.Row="1" Margin="12">
            <TabItem Header="主页">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition x:Name="HomeTopRow" Height="*" />
                        <RowDefinition x:Name="HomeSplitterRow" Height="Auto" />
                        <RowDefinition x:Name="HomeBottomRow" Height="*" />
                    </Grid.RowDefinitions>
                    <ui:DataGrid x:Name="HomeFilesGrid" ItemsSource="{Binding Files}" SelectedItem="{Binding SelectedFile, Mode=TwoWay}" AutoGenerateColumns="False" CanUserAddRows="False"
                                 IsReadOnly="False"
                                 ColumnWidth="Auto" HorizontalScrollBarVisibility="Auto" MinHeight="100" CanUserSortColumns="False"
                                 AllowDrop="True"
                                 PreviewMouseLeftButtonDown="OnHomeFilesPreviewMouseLeftButtonDown"
                                 MouseMove="OnHomeFilesMouseMove"
                                 DragOver="OnHomeFilesDragOver"
                                 Drop="OnHomeFilesDrop">
                        <ui:DataGrid.Columns>
                            <DataGridTemplateColumn Header="选择" Width="Auto" MinWidth="60">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" IsEnabled="{Binding HasAnyHomeServerSelected}"
                                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="本地文件" Binding="{Binding LocalPath}" IsReadOnly="True" Width="Auto" MinWidth="120" />
                            <DataGridTextColumn Header="目标路径" Binding="{Binding TargetPath}" IsReadOnly="True" Width="Auto" MinWidth="80" />
                            <DataGridTemplateColumn Header="服务器" Width="Auto" MinWidth="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ItemsControl ItemsSource="{Binding HomeServerSelections}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Content="{Binding Alias}" IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="4,0" MinWidth="0"
                                                              Width="Auto" HorizontalAlignment="Left" />
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </ui:DataGrid.Columns>
                    </ui:DataGrid>


                    <!-- 分隔顶部文件表和底部区域 -->
                    <GridSplitter Grid.Row="1"
                                  Height="10"
                                  HorizontalAlignment="Stretch"
                                  Background="#33000000"
                                  ResizeDirection="Rows"
                                  ResizeBehavior="PreviousAndNext"
                                  ShowsPreview="True"
                                  IsTabStop="False"
                                  Cursor="SizeNS"
                                  Margin="0,6,0,6"
                                  DragCompleted="OnHomeSplitterDragCompleted" />

                    <!-- 底部区域：上方按钮，下方日志 -->
                    <DockPanel Grid.Row="2" LastChildFill="True">
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="0,0,0,8">
                            <Button Content="一键上传" Width="120" Click="OnUploadClick" IsEnabled="{Binding CanUpload}" />
                            <TextBlock Text="  进度：" VerticalAlignment="Center" Margin="12,0,0,0" />
                            <ProgressBar Width="300" Height="20" Minimum="0" Maximum="100" Value="{Binding UploadProgress}" />
                            <TextBlock Text="{Binding UploadStatus}" Margin="12,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                        <GroupBox Header="日志" MinHeight="60">
                            <RichTextBox x:Name="LogRichBox" IsReadOnly="True" VerticalScrollBarVisibility="Auto" Foreground="White" />
                        </GroupBox>
                    </DockPanel>
                </Grid>
            </TabItem>
            <TabItem Header="文件配置">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <DataGrid x:Name="FilesGrid" ItemsSource="{Binding Files}" AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="False" ColumnWidth="Auto" CanUserSortColumns="False"
                              HorizontalScrollBarVisibility="Auto"
                              PreviewMouseLeftButtonDown="OnDataGridPreviewMouseLeftButtonDown">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="本地文件" Binding="{Binding LocalPath}" IsReadOnly="True" Width="Auto" MinWidth="120" />
                            <DataGridTextColumn Header="目标路径" Binding="{Binding TargetPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" MinWidth="120" />
                            <DataGridTemplateColumn Header="服务器" Width="Auto" MinWidth="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ItemsControl ItemsSource="{Binding ServerSelections}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Content="{Binding Alias}" IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="4,0"
                                                              Width="Auto" MinWidth="0" HorizontalAlignment="Left" />
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="脚本" Width="Auto" MinWidth="60">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="编辑" Width="80" Click="OnEditScriptClick" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="权限" Binding="{Binding Permission, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" MinWidth="60" />
                        </DataGrid.Columns>
                    </DataGrid>
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                        <Button Content="添加文件" Width="100" Click="OnAddFileClick" />
                        <Button Content="移除所选" Width="100" Margin="8,0,0,0" Click="OnRemoveFileClick" />
                    </StackPanel>
                </Grid>
            </TabItem>
            <TabItem Header="服务器配置">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid.Resources>
                        <CollectionViewSource x:Key="ServersView"
                                              Source="{Binding Servers}"
                                              IsLiveSortingRequested="True">
                            <CollectionViewSource.SortDescriptions>
                                <scm:SortDescription PropertyName="Alias" Direction="Ascending" />
                            </CollectionViewSource.SortDescriptions>
                            <CollectionViewSource.LiveSortingProperties>
                                <sys:String>Alias</sys:String>
                            </CollectionViewSource.LiveSortingProperties>
                        </CollectionViewSource>
                    </Grid.Resources>
                    <DataGrid x:Name="ServersGrid" ItemsSource="{Binding Source={StaticResource ServersView}}" AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="False" ColumnWidth="Auto"
                              CanUserSortColumns="False"
                              HorizontalScrollBarVisibility="Auto"
                              PreviewMouseLeftButtonDown="OnDataGridPreviewMouseLeftButtonDown">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="别名" Binding="{Binding Alias, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" Width="Auto" MinWidth="80" />
                            <DataGridTextColumn Header="服务器IP" Binding="{Binding Host, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" MinWidth="120" />
                            <DataGridTextColumn Header="端口" Binding="{Binding Port, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" MinWidth="60" />
                            <DataGridTextColumn Header="用户名" Binding="{Binding Username, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" MinWidth="100" />
                            <DataGridTextColumn Header="密码" Binding="{Binding Password, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" MinWidth="100" />
                        </DataGrid.Columns>
                    </DataGrid>
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                        <Button Content="添加服务器" Width="100" Click="OnAddServerClick" />
                        <Button Content="移除所选" Width="100" Margin="8,0,0,0" Click="OnRemoveServerClick" />
                    </StackPanel>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</ui:FluentWindow>